<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>To-Do App</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background-color: #f9f9f9; }
.todo-container { max-width: 500px; margin: 50px auto; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.todo-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
.todo-item:last-child { border-bottom: none; }
.todo-actions button { margin-left: 5px; }
.edit-input { width: 100%; }
</style>
</head>
<body>
<div class="todo-container">
<h3 class="text-center mb-4">To-Do List</h3>
<div class="input-group mb-3">
  <input id="todo-input" type="text" class="form-control" placeholder="Enter a task">
  <button class="btn btn-primary" id="add-btn">Add</button>
</div>
<ul id="todo-list" class="list-unstyled"></ul>
</div>

<script>
const API = "http://localhost:3000";
let todos = [];

async function fetchTodos() {
  try {
    const res = await fetch(`${API}/get-items`);
    const data = await res.json();
    console.log("Fetched from DB:", data);
    todos = data.map(item => ({ id: item.ID, text: item.itemDescription, editing: false }));
    renderTodos();
  } catch (err) {
    console.error("fetchTodos error:", err);
    alert("Could not fetch todos. Is the server running?");
  }
}

function renderTodos() {
  const list = document.getElementById('todo-list');
  list.innerHTML = '';
  todos.forEach((todo, index) => {
    const li = document.createElement('li');
    li.className = 'todo-item';
    if (todo.editing) {
      const input = document.createElement('input');
      input.className = 'form-control edit-input';
      input.value = todo.text;
      input.addEventListener('input', (e) => todos[index].text = e.target.value);

      const actions = document.createElement('div');
      actions.className = 'todo-actions';

      const saveBtn = document.createElement('button');
      saveBtn.className = 'btn btn-success btn-sm';
      saveBtn.textContent = 'Save';
      saveBtn.addEventListener('click', () => saveTodo(index));

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn btn-secondary btn-sm';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.addEventListener('click', () => { todos[index].editing = false; renderTodos(); });

      actions.appendChild(saveBtn);
      actions.appendChild(cancelBtn);

      li.appendChild(input);
      li.appendChild(actions);
    } else {
      const span = document.createElement('span');
      span.textContent = todo.text;

      const actions = document.createElement('div');
      actions.className = 'todo-actions';

      const editBtn = document.createElement('button');
      editBtn.className = 'btn btn-warning btn-sm';
      editBtn.textContent = 'Edit';
      editBtn.addEventListener('click', () => { todos[index].editing = true; renderTodos(); });

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn btn-success btn-sm';
      deleteBtn.textContent = 'Completed';
      deleteBtn.addEventListener('click', () => deleteTodo(index));

      actions.appendChild(editBtn);
      actions.appendChild(deleteBtn);

      li.appendChild(span);
      li.appendChild(actions);
    }
    list.appendChild(li);
  });
}

document.getElementById('add-btn').addEventListener('click', async () => {
  const value = document.getElementById('todo-input').value.trim();
  if (!value) return alert("Enter a task");
  try {
    const res = await fetch(`${API}/add-item`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ value })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Add failed");
    document.getElementById('todo-input').value = '';
    await fetchTodos();
  } catch (err) {
    console.error("Add error:", err);
    alert("Add failed. See console.");
  }
});

async function saveTodo(index) {
  const todo = todos[index];
  try {
    const res = await fetch(`${API}/update-item/${todo.id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ value: todo.text })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Update failed");
    await fetchTodos();
  } catch (err) {
    console.error("Save error:", err);
    alert("Update failed. See console.");
  }
}

async function deleteTodo(index) {
  const todo = todos[index];
  if (!confirm("Completed this task?")) return;
  try {
    const res = await fetch(`${API}/delete-item/${todo.id}`, { method: 'DELETE' });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Delete failed");
    await fetchTodos();
  } catch (err) {
    console.error("Delete error:", err);
    alert("Delete failed. See console.");
  }
}

document.addEventListener('DOMContentLoaded', fetchTodos);
</script>
</body>
</html>
